package com.anyoneschristmas.app

import android.content.Context
import android.content.Intent
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Paint
import android.graphics.Rect
import android.graphics.Typeface
import android.os.Bundle
import android.text.Layout
import android.text.StaticLayout
import android.text.TextPaint
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material.icons.filled.Share
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.content.ContextCompat
import androidx.core.content.FileProvider
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import com.anyoneschristmas.app.R
import com.anyoneschristmas.app.model.CardTemplate
import com.anyoneschristmas.app.model.TEMPLATES
import com.anyoneschristmas.app.ui.theme.*
import java.io.File
import java.io.FileOutputStream

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            FestiveGreetingsTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    AppNavigation()
                }
            }
        }
    }
}

val PREMADE_GREETINGS = listOf(
    "Wishing you a season full of light and laughter for you and your family.",
    "May your days be merry and bright, and your new year full of hope.",
    "Sending you festive vibes and warm holiday hugs!",
    "Have a holly, jolly Christmas and a fantastic New Year!",
    "Warmest thoughts and best wishes for a wonderful holiday season.",
    "Peace, love, and joy to you this Christmas.",
    "Cheers to warm holiday memories and a bright new year!",
    "May the magic of Christmas fill every corner of your heart and home."
)

@Composable
fun AppNavigation() {
    val navController = rememberNavController()
    var selectedTemplateId by rememberSaveable { mutableStateOf(TEMPLATES.first().id) }
    var message by rememberSaveable { mutableStateOf(PREMADE_GREETINGS.first()) }
    var senderName by rememberSaveable { mutableStateOf("") }

    val selectedTemplate = TEMPLATES.find { it.id == selectedTemplateId } ?: TEMPLATES.first()

    NavHost(navController = navController, startDestination = "home") {
        composable("home") {
            HomeScreen(
                onTemplateSelected = { template ->
                    selectedTemplateId = template.id
                    navController.navigate("edit")
                }
            )
        }
        composable("edit") {
            val context = LocalContext.current
            EditScreen(
                template = selectedTemplate,
                message = message,
                sender = senderName,
                onMessageChange = { message = it },
                onSenderChange = { senderName = it },
                onBack = { navController.popBackStack() },
                onShare = {
                   generateAndShareCard(context, selectedTemplate, message, senderName)
                }
            )
        }
    }
}

/**
 * Native Android Bitmap Generation.
 * Creates a high-quality PNG of the card.
 * UPDATED: Uses 1000x1500 (2:3 Aspect Ratio) to match vector drawables without distortion.
 */
fun generateAndShareCard(context: Context, template: CardTemplate, message: String, sender: String) {
    try {
        // 1. Create Bitmap Canvas (2:3 Portrait Aspect Ratio)
        val width = 1000
        val height = 1500
        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
        val canvas = Canvas(bitmap)

        // 2. Draw Vector Background
        val bgDrawable = ContextCompat.getDrawable(context, template.imageRes)
        bgDrawable?.setBounds(0, 0, width, height)
        bgDrawable?.draw(canvas)

        // 3. Draw Dark Overlay
        canvas.drawColor(template.overlayColor.toArgb())

        // 4. Draw Inner Border
        val borderPaint = Paint().apply {
            color = android.graphics.Color.WHITE
            style = Paint.Style.STROKE
            strokeWidth = 20f
            alpha = 80
        }
        val padding = 60
        val borderRect = Rect(padding, padding, width - padding, height - padding)
        canvas.drawRect(borderRect, borderPaint)

        // 5. Draw Decorative Snowflake (Higher up to allow room for central art)
        val iconPaint = TextPaint().apply {
            color = template.accentColor.toArgb()
            textSize = 140f
            textAlign = Paint.Align.CENTER
            isAntiAlias = true
            setShadowLayer(12f, 0f, 0f, android.graphics.Color.BLACK)
        }
        canvas.drawText("‚ùÑ", width / 2f, 250f, iconPaint)

        // 6. Draw Message (Centered Vertically)
        val textPaint = TextPaint().apply {
            color = template.textColor.toArgb()
            textSize = 70f
            isAntiAlias = true
            typeface = Typeface.create(Typeface.SERIF, Typeface.BOLD)
            textAlign = Paint.Align.CENTER
            setShadowLayer(15f, 0f, 5f, android.graphics.Color.BLACK)
        }

        // Use StaticLayout for automatic line wrapping
        val textLayoutWidth = width - 240
        val textLayout = StaticLayout.Builder.obtain(message, 0, message.length, textPaint, textLayoutWidth)
            .setAlignment(Layout.Alignment.ALIGN_CENTER)
            .setLineSpacing(0f, 1.2f)
            .setIncludePad(false)
            .build()

        canvas.save()
        // Center text, slightly offset upwards to not hit bottom art
        val textY = (height - textLayout.height) / 2f - 50f
        canvas.translate(width / 2f, textY)
        textLayout.draw(canvas)
        canvas.restore()

        // 7. Draw Sender (At the bottom)
        if (sender.isNotBlank()) {
            val senderPaint = TextPaint(textPaint).apply {
                textSize = 50f
                typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD_ITALIC)
                color = template.accentColor.toArgb()
                setShadowLayer(8f, 0f, 2f, android.graphics.Color.BLACK)
            }
            val senderText = "Sent by $sender"
            canvas.drawText(senderText, width / 2f, height - 150f, senderPaint)
            
            // Decorative lines next to sender
            val linePaint = Paint().apply {
                color = template.accentColor.toArgb()
                strokeWidth = 5f
                setShadowLayer(5f, 0f, 0f, android.graphics.Color.BLACK)
            }
            val senderTextWidth = senderPaint.measureText(senderText)
            val lineLength = 100f
            val lineY = height - 165f
            val startX = (width - senderTextWidth) / 2f
            
            canvas.drawLine(startX - lineLength - 30, lineY, startX - 30, lineY, linePaint)
            canvas.drawLine(width / 2f + senderTextWidth / 2f + 30, lineY, width / 2f + senderTextWidth / 2f + 30 + lineLength, lineY, linePaint)
        }

        // 8. Save Bitmap to Cache
        val imagesFolder = File(context.cacheDir, "images")
        imagesFolder.mkdirs()
        val file = File(imagesFolder, "christmas_card.png")
        val stream = FileOutputStream(file)
        bitmap.compress(Bitmap.CompressFormat.PNG, 100, stream)
        stream.flush()
        stream.close()

        // 9. Share URI
        val uri = FileProvider.getUriForFile(
            context,
            "${context.packageName}.fileprovider",
            file
        )

        val intent = Intent(Intent.ACTION_SEND).apply {
            putExtra(Intent.EXTRA_STREAM, uri)
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
            type = "image/png"
            putExtra(Intent.EXTRA_TEXT, "Here is a holiday card for you! üéÑ")
        }
        context.startActivity(Intent.createChooser(intent, "Share Holiday Card"))

    } catch (e: Exception) {
        e.printStackTrace()
        Toast.makeText(context, "Error sharing card", Toast.LENGTH_SHORT).show()
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun HomeScreen(onTemplateSelected: (CardTemplate) -> Unit) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("Festive Greetings", fontFamily = FontFamily.Serif, fontWeight = FontWeight.Bold) },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Slate900,
                    titleContentColor = Amber400
                )
            )
        },
        containerColor = Slate950
    ) { padding ->
        Column(modifier = Modifier.padding(padding)) {
            Text(
                text = "Select a Card Style",
                modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),
                color = Slate700,
                style = MaterialTheme.typography.labelLarge,
                fontSize = 14.sp
            )
            LazyVerticalGrid(
                columns = GridCells.Fixed(2),
                contentPadding = PaddingValues(16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(TEMPLATES) { template ->
                    CardTemplateItem(template, onClick = { onTemplateSelected(template) })
                }
            }
        }
    }
}

@Composable
fun CardTemplateItem(template: CardTemplate, onClick: () -> Unit) {
    Card(
        modifier = Modifier
            .aspectRatio(0.67f) // 2:3 Portrait Ratio
            .clickable { onClick() },
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(8.dp)
    ) {
        Box {
            Image(
                painter = painterResource(id = template.imageRes),
                contentDescription = template.name,
                contentScale = ContentScale.Crop,
                modifier = Modifier.fillMaxSize()
            )
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Brush.verticalGradient(listOf(Color.Transparent, Color.Black.copy(alpha = 0.8f))))
            )
            Text(
                text = template.name,
                color = Color.White,
                modifier = Modifier
                    .align(Alignment.BottomStart)
                    .padding(12.dp),
                fontWeight = FontWeight.Bold
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun EditScreen(
    template: CardTemplate,
    message: String,
    sender: String,
    onMessageChange: (String) -> Unit,
    onSenderChange: (String) -> Unit,
    onBack: () -> Unit,
    onShare: () -> Unit
) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("Personalize", fontFamily = FontFamily.Serif) },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back", tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Slate900,
                    titleContentColor = Color.White
                )
            )
        },
        bottomBar = {
            Button(
                onClick = onShare,
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(containerColor = Red600),
                shape = RoundedCornerShape(12.dp)
            ) {
                Icon(Icons.Default.Share, contentDescription = null, modifier = Modifier.size(20.dp))
                Spacer(modifier = Modifier.width(8.dp))
                Text("Share Card Image", fontSize = 16.sp, fontWeight = FontWeight.Bold)
            }
        },
        containerColor = Slate950
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .padding(16.dp)
                .verticalScroll(rememberScrollState())
        ) {
            CardPreview(template, message, sender)
            Spacer(modifier = Modifier.height(24.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text("Your Message", color = Color.Gray, fontSize = 14.sp)
                TextButton(
                    onClick = {
                        val newMessage = PREMADE_GREETINGS.filter { it != message }.random()
                        onMessageChange(newMessage)
                    },
                    colors = ButtonDefaults.textButtonColors(contentColor = Amber400)
                ) {
                    Icon(Icons.Default.Refresh, contentDescription = null, modifier = Modifier.size(16.dp))
                    Spacer(modifier = Modifier.width(4.dp))
                    Text("Shuffle Message")
                }
            }

            OutlinedTextField(
                value = message,
                onValueChange = onMessageChange,
                modifier = Modifier.fillMaxWidth(),
                minLines = 3,
                shape = RoundedCornerShape(12.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedTextColor = Color.White,
                    unfocusedTextColor = Color.White,
                    focusedBorderColor = Amber400,
                    unfocusedBorderColor = Slate700,
                    cursorColor = Amber400,
                    focusedContainerColor = Slate900,
                    unfocusedContainerColor = Slate900
                )
            )

            Spacer(modifier = Modifier.height(20.dp))
            
            Text("From", color = Color.Gray, fontSize = 14.sp, modifier = Modifier.padding(bottom = 8.dp))
            OutlinedTextField(
                value = sender,
                onValueChange = onSenderChange,
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(12.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedTextColor = Color.White,
                    unfocusedTextColor = Color.White,
                    focusedBorderColor = Amber400,
                    unfocusedBorderColor = Slate700,
                    cursorColor = Amber400,
                    focusedContainerColor = Slate900,
                    unfocusedContainerColor = Slate900
                ),
                placeholder = { Text("Your Name", color = Color.Gray) }
            )
            Spacer(modifier = Modifier.height(80.dp))
        }
    }
}

@Composable
fun CardPreview(template: CardTemplate, message: String, sender: String) {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(0.67f) // 2:3 Portrait Ratio
            .clip(RoundedCornerShape(12.dp))
            .border(1.dp, Slate700, RoundedCornerShape(12.dp))
    ) {
        // Local Image Loading
        Image(
            painter = painterResource(id = template.imageRes),
            contentDescription = null,
            contentScale = ContentScale.Crop,
            modifier = Modifier.fillMaxSize()
        )
        
        Box(modifier = Modifier.fillMaxSize().background(template.overlayColor))
        
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(12.dp)
                .border(1.dp, Color.White.copy(alpha = 0.2f), RoundedCornerShape(4.dp))
        )

        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(32.dp),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text("‚ùÑ", fontSize = 24.sp, color = template.accentColor)
            Spacer(modifier = Modifier.height(16.dp))

            Text(
                text = message.ifEmpty { "Season's Greetings" },
                color = template.textColor,
                textAlign = TextAlign.Center,
                fontFamily = FontFamily.Serif,
                style = MaterialTheme.typography.headlineMedium.copy(
                    shadow = androidx.compose.ui.graphics.Shadow(
                        color = Color.Black, 
                        blurRadius = 8f
                    )
                )
            )
            
            if (sender.isNotEmpty()) {
                Spacer(modifier = Modifier.height(24.dp))
                Row(verticalAlignment = Alignment.CenterVertically) {
                     Box(modifier = Modifier.width(30.dp).height(1.dp).background(template.accentColor))
                     Text(
                        text = " SENT BY ",
                        color = template.accentColor,
                        fontSize = 10.sp,
                        fontWeight = FontWeight.Bold
                    )
                    Box(modifier = Modifier.width(30.dp).height(1.dp).background(template.accentColor))
                }
                Text(
                    text = sender,
                    color = template.textColor,
                    fontSize = 20.sp,
                    fontFamily = FontFamily.Cursive,
                    fontWeight = FontWeight.Bold
                )
            }
        }
    }
}