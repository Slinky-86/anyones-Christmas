package com.example.festivegreetings

import android.content.Intent
import android.os.Bundle
import android.util.Base64
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.AutoAwesome
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Edit
import androidx.compose.material.icons.filled.Share
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import coil.compose.AsyncImage
import com.example.festivegreetings.model.CardTemplate
import com.example.festivegreetings.model.TEMPLATES
import com.example.festivegreetings.service.GeminiService
import com.example.festivegreetings.ui.theme.FestiveGreetingsTheme
import com.example.festivegreetings.ui.theme.Slate900
import com.example.festivegreetings.ui.theme.Slate950
import kotlinx.coroutines.launch
import java.net.URLEncoder

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            FestiveGreetingsTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    AppNavigation()
                }
            }
        }
    }
}

@Composable
fun AppNavigation() {
    val navController = rememberNavController()
    // Shared State
    var selectedTemplate by remember { mutableStateOf(TEMPLATES.first()) }
    var message by remember { mutableStateOf("Wishing you a season full of light and laughter.") }
    var senderName by remember { mutableStateOf("") }

    NavHost(navController = navController, startDestination = "home") {
        composable("home") {
            HomeScreen(
                onTemplateSelected = {
                    selectedTemplate = it
                    navController.navigate("edit")
                }
            )
        }
        composable("edit") {
            EditScreen(
                template = selectedTemplate,
                message = message,
                sender = senderName,
                onMessageChange = { message = it },
                onSenderChange = { senderName = it },
                onShare = {
                    // Generate URL for sharing
                    val baseUrl = "https://your-web-app-url.vercel.app/" // Replace with actual hosted URL
                    val encodedMsg = Base64.encodeToString(message.toByteArray(), Base64.NO_WRAP)
                    val encodedSender = Base64.encodeToString(senderName.toByteArray(), Base64.NO_WRAP)
                    val shareUrl = "$baseUrl#t=${selectedTemplate.id}&m=$encodedMsg&s=$encodedSender"

                    val sendIntent = Intent().apply {
                        action = Intent.ACTION_SEND
                        putExtra(Intent.EXTRA_TEXT, "I sent you a festive greeting! Open it here: $shareUrl")
                        type = "text/plain"
                    }
                    val shareIntent = Intent.createChooser(sendIntent, "Share Holiday Cheer")
                    navController.context.startActivity(shareIntent)
                }
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun HomeScreen(onTemplateSelected: (CardTemplate) -> Unit) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("Festive Greetings", fontFamily = FontFamily.Serif) },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Slate900,
                    titleContentColor = Color.White
                )
            )
        }
    ) { padding ->
        Column(modifier = Modifier.padding(padding)) {
            Text(
                text = "Choose a Theme",
                modifier = Modifier.padding(16.dp),
                color = Color.White,
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold
            )
            LazyVerticalGrid(
                columns = GridCells.Fixed(2),
                contentPadding = PaddingValues(16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(TEMPLATES) { template ->
                    CardTemplateItem(template, onClick = { onTemplateSelected(template) })
                }
            }
        }
    }
}

@Composable
fun CardTemplateItem(template: CardTemplate, onClick: () -> Unit) {
    Card(
        modifier = Modifier
            .aspectRatio(1f)
            .clickable { onClick() },
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(8.dp)
    ) {
        Box {
            AsyncImage(
                model = template.imageUrl,
                contentDescription = template.name,
                contentScale = ContentScale.Crop,
                modifier = Modifier.fillMaxSize()
            )
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Brush.verticalGradient(listOf(Color.Transparent, Color.Black.copy(alpha = 0.7f))))
            )
            Text(
                text = template.name,
                color = Color.White,
                modifier = Modifier
                    .align(Alignment.BottomStart)
                    .padding(12.dp),
                fontWeight = FontWeight.Bold
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun EditScreen(
    template: CardTemplate,
    message: String,
    sender: String,
    onMessageChange: (String) -> Unit,
    onSenderChange: (String) -> Unit,
    onShare: () -> Unit
) {
    val geminiService = remember { GeminiService() }
    val scope = rememberCoroutineScope()
    var isGenerating by remember { mutableStateOf(false) }

    Scaffold(
        bottomBar = {
            Button(
                onClick = onShare,
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(containerColor = Color(0xFFB91C1C)) // Red
            ) {
                Icon(Icons.Default.Share, contentDescription = null, modifier = Modifier.size(20.dp))
                Spacer(modifier = Modifier.width(8.dp))
                Text("Share Card")
            }
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .background(Slate950)
                .padding(16.dp)
                .verticalScroll(androidx.compose.foundation.rememberScrollState())
        ) {
            // Preview
            CardPreview(template, message, sender)
            
            Spacer(modifier = Modifier.height(24.dp))
            
            // AI Helper
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text("Your Message", color = Color.Gray, fontSize = 14.sp)
                TextButton(
                    onClick = {
                        scope.launch {
                            isGenerating = true
                            val result = geminiService.generateGreeting("Friend", "Warm")
                            onMessageChange(result)
                            isGenerating = false
                        }
                    },
                    enabled = !isGenerating
                ) {
                    if (isGenerating) {
                        CircularProgressIndicator(modifier = Modifier.size(16.dp), color = Color(0xFFFBBF24))
                    } else {
                        Icon(Icons.Default.AutoAwesome, contentDescription = null, tint = Color(0xFFFBBF24))
                        Spacer(modifier = Modifier.width(4.dp))
                        Text("AI Magic", color = Color(0xFFFBBF24))
                    }
                }
            }

            OutlinedTextField(
                value = message,
                onValueChange = onMessageChange,
                modifier = Modifier.fillMaxWidth(),
                minLines = 3,
                colors = OutlinedTextFieldDefaults.colors(
                    focusedTextColor = Color.White,
                    unfocusedTextColor = Color.White,
                    focusedBorderColor = Color(0xFFFBBF24),
                    unfocusedBorderColor = Color.Gray
                )
            )

            Spacer(modifier = Modifier.height(16.dp))
            
            Text("From", color = Color.Gray, fontSize = 14.sp)
            OutlinedTextField(
                value = sender,
                onValueChange = onSenderChange,
                modifier = Modifier.fillMaxWidth(),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedTextColor = Color.White,
                    unfocusedTextColor = Color.White,
                    focusedBorderColor = Color(0xFFFBBF24),
                    unfocusedBorderColor = Color.Gray
                ),
                placeholder = { Text("Your Name", color = Color.Gray) }
            )
        }
    }
}

@Composable
fun CardPreview(template: CardTemplate, message: String, sender: String) {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(0.75f)
            .clip(RoundedCornerShape(8.dp))
    ) {
        AsyncImage(
            model = template.imageUrl,
            contentDescription = null,
            contentScale = ContentScale.Crop,
            modifier = Modifier.fillMaxSize()
        )
        // Overlay
        Box(modifier = Modifier.fillMaxSize().background(template.overlayColor))
        
        // Inner Frame
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp)
                .border(1.dp, Color.White.copy(alpha = 0.3f), RoundedCornerShape(4.dp))
        )

        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(32.dp),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = message.ifEmpty { "Season's Greetings" },
                color = template.textColor,
                fontSize = 24.sp,
                fontWeight = FontWeight.SemiBold,
                textAlign = TextAlign.Center,
                fontFamily = FontFamily.Serif,
                style = MaterialTheme.typography.headlineMedium.copy(shadow = androidx.compose.ui.graphics.Shadow(color = Color.Black, blurRadius = 4f))
            )
            
            if (sender.isNotEmpty()) {
                Spacer(modifier = Modifier.height(24.dp))
                Text(
                    text = "From",
                    color = template.accentColor,
                    fontSize = 12.sp,
                    letterSpacing = 2.sp
                )
                Text(
                    text = sender,
                    color = template.textColor,
                    fontSize = 20.sp,
                    fontFamily = FontFamily.Cursive
                )
            }
        }
    }
}
